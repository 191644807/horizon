<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/endpoint/query.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">src/endpoint/</a> query.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">11.67% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>7/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/0</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">12.28% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>7/57</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict';
&nbsp;
const query = require('../schema/horizon_protocol').query;
const check = require('../error.js').check;
&nbsp;
const Joi = require('joi');
const r = require('rethinkdb');
&nbsp;
// This is also used by the 'subscribe' endpoint
const make_reql = (raw_request, metadata) =&gt; {
<span class="cstat-no" title="statement not covered" >  const parsed = Joi.validate(raw_request.options, query);</span>
<span class="cstat-no" title="statement not covered" >  if (parsed.error !== null) { <span class="cstat-no" title="statement not covered" >throw new Error(parsed.error.details[0].message); </span>}</span>
<span class="cstat-no" title="statement not covered" >  const options = parsed.value;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  const table = metadata.get_table(parsed.value.collection);</span>
<span class="cstat-no" title="statement not covered" >  let reql = r.table(table.name);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  const ordered_between = (obj) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >    const order_keys = (options.order &amp;&amp; options.order[0]) ||</span>
                       (options.above &amp;&amp; Object.keys(options.above[0])) ||
                       (options.below &amp;&amp; Object.keys(options.below[0])) || [ ];
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (order_keys.length &gt;= 1) {</span>
<span class="cstat-no" title="statement not covered" >      const k = order_keys[0];</span>
<span class="cstat-no" title="statement not covered" >      check(!options.above || options.above[0][k] !== undefined,</span>
            '"above" must be on the same field as the first in "order".');
<span class="cstat-no" title="statement not covered" >      check(!options.below || options.below[0][k] !== undefined,</span>
            '"below" must be on the same field as the first in "order"');
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    order_keys.forEach((k) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      check(obj[k] === undefined,</span>
            `"${k}" cannot be used in "order", "above", or "below" when finding by that field.`);
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    const index = table.get_matching_index(Object.keys(obj), order_keys);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    const get_bound = (name) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      const eval_key = (key) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >        if (obj[key] !== undefined) {</span>
<span class="cstat-no" title="statement not covered" >          return obj[key];</span>
        } else <span class="cstat-no" title="statement not covered" >if (options[name] &amp;&amp; options[name][0][key] !== undefined) {</span>
<span class="cstat-no" title="statement not covered" >          return options[name][0][key];</span>
        } else <span class="cstat-no" title="statement not covered" >if (options[name] &amp;&amp; options[name][1] === 'open') {</span>
<span class="cstat-no" title="statement not covered" >          return name === 'above' ? r.maxval : r.minval;</span>
        } else {
<span class="cstat-no" title="statement not covered" >          return name === 'above' ? r.minval : r.maxval;</span>
        }
      };
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (index.name === 'id') {</span>
<span class="cstat-no" title="statement not covered" >        return eval_key('id');</span>
      }
<span class="cstat-no" title="statement not covered" >      return index.fields.map((k) =&gt; <span class="cstat-no" title="statement not covered" >eval_key(k))</span>;</span>
    };
&nbsp;
<span class="cstat-no" title="statement not covered" >    const above_value = get_bound('above');</span>
<span class="cstat-no" title="statement not covered" >    const below_value = get_bound('below');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    const optargs = {</span>
      index: index.name,
      leftBound: options.above ? options.above[1] : 'closed',
      rightBound: options.below ? options.below[1] : 'closed',
    };
&nbsp;
<span class="cstat-no" title="statement not covered" >    const order = (options.order &amp;&amp; options.order[1] === 'descending') ?</span>
      r.desc(index.name) : index.name;
<span class="cstat-no" title="statement not covered" >    return reql.orderBy({ index: order }).between(above_value, below_value, optargs);</span>
  };
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (options.find) {</span>
<span class="cstat-no" title="statement not covered" >    reql = ordered_between(options.find).limit(1);</span>
  } else <span class="cstat-no" title="statement not covered" >if (options.find_all &amp;&amp; options.find_all.length &gt; 1) {</span>
<span class="cstat-no" title="statement not covered" >    reql = r.union.apply(r, options.find_all.map((x) =&gt; <span class="cstat-no" title="statement not covered" >ordered_between(x))</span>);</span>
  } else {
<span class="cstat-no" title="statement not covered" >    reql = ordered_between((options.find_all &amp;&amp; options.find_all[0]) || { });</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (options.limit !== undefined) {</span>
<span class="cstat-no" title="statement not covered" >    reql = reql.limit(options.limit);</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return reql;</span>
};
&nbsp;
const handle_response = (request, res, send_cb) =&gt; {
<span class="cstat-no" title="statement not covered" >  if (res !== null &amp;&amp; res.constructor.name === 'Cursor') {</span>
<span class="cstat-no" title="statement not covered" >    request.add_cursor(res);</span>
<span class="cstat-no" title="statement not covered" >    res.each((err, item) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >      if (err !== null) {</span>
<span class="cstat-no" title="statement not covered" >        send_cb({ error: `${err}` });</span>
      } else {
<span class="cstat-no" title="statement not covered" >        send_cb({ data: [ item ] });</span>
      }
    }, () =&gt; {
<span class="cstat-no" title="statement not covered" >      request.remove_cursor();</span>
<span class="cstat-no" title="statement not covered" >      send_cb({ data: [ ], state: 'complete' });</span>
    });
  } else <span class="cstat-no" title="statement not covered" >if (res !== null &amp;&amp; res.constructor.name === 'Array') {</span>
<span class="cstat-no" title="statement not covered" >    send_cb({ data: res, state: 'complete' });</span>
  } else {
<span class="cstat-no" title="statement not covered" >    send_cb({ data: [ res ], state: 'complete' });</span>
  }
};
&nbsp;
module.exports = { make_reql, handle_response };
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Apr 24 2016 20:31:45 GMT-0400 (EDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
